<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Writable Résumé Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { font-size: 1.5em; margin-bottom: 1em; }
    button { padding: 10px 20px; margin: 10px 0; cursor: pointer; }
    .card { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 10px; }
    .label { font-weight: bold; }
    #status { margin-top: 10px; white-space: pre-line; }
    .row { display: grid; grid-template-columns: 180px 1fr; gap: 10px; align-items: center; }
    .muted { color: #666; font-size: 0.95em; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 6px; }
    a { color: #0a58ca; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1>Writable Résumé Admin</h1>

  <div class="card">
    <div class="row"><span class="label">Network required:</span><span>Sepolia <code>(chainId 11155111)</code></span></div>
    <div class="row"><span class="label">Contract address:</span><span id="contractLink">—</span></div>
    <div class="row"><span class="label">ABI source:</span><span class="muted"><code>./config/abi.json</code></span></div>
    <div class="row"><span class="label">Config:</span><span class="muted"><code>./config/contract.json</code></span></div>
    <button id="btnConnect">Connect MetaMask</button>
    <div id="status" class="muted">Status: idle</div>
  </div>

  <div class="card" id="walletCard" style="display:none">
    <div class="row"><span class="label">Wallet:</span><span id="walletAddr">—</span></div>
    <div class="row"><span class="label">Chain:</span><span id="chainInfo">—</span></div>
  </div>

  <div class="card" id="contractCard" style="display:none">
    <h2 style="margin-top:0">Contract (read)</h2>
    <div class="row"><span class="label">owner():</span><span id="ownerVal">—</span></div>
    <div class="row"><span class="label">meta():</span><span id="metaVal" class="muted">—</span></div>
    <button id="btnRefresh">Refresh Reads</button>
  </div>

  <!-- Ethers v5 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
  (async function () {
    const UI = {
      addrEl: document.getElementById('contractAddress') || null,
      statusEl: document.getElementById('status') || null,
      connectBtn: document.getElementById('connectBtn') || document.querySelector('button')
    };

    async function loadJson(path) {
      const r = await fetch(path, { cache: 'no-store' });
      if (!r.ok) throw new Error(`Fetch failed: ${path}`);
      return r.json();
    }

    let config, abi;
    try {
      [config, abi] = await Promise.all([
        loadJson('./config/contract.json'),
        loadJson('./config/abi.json')
      ]);
      if (UI.addrEl) UI.addrEl.textContent = config.contractAddress || '—';
      setStatus('Ready: config/ABI loaded.');
    } catch (e) {
      setStatus('ABI or config missing: place files at ./config/abi.json and ./config/contract.json');
      console.error(e);
      return;
    }

    const REQUIRED_CHAIN_ID_DEC = 11155111;
    const REQUIRED_CHAIN_ID_HEX = '0xaa36a7';

    async function ensureSepolia(ethereum) {
      const hex = await ethereum.request({ method: 'eth_chainId' });
      const current = parseInt(hex, 16);
      if (current === REQUIRED_CHAIN_ID_DEC) return true;

      setStatus(`Wrong network (${hex}). Switching to Sepolia…`);
      try {
        await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: REQUIRED_CHAIN_ID_HEX }] });
        return true;
      } catch (err) {
        if (err?.code === 4902) {
          await ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: REQUIRED_CHAIN_ID_HEX,
              chainName: 'Sepolia',
              nativeCurrency: { name: 'Sepolia ETH', symbol: 'SepoliaETH', decimals: 18 },
              rpcUrls: ['https://sepolia.drpc.org', 'https://rpc2.sepolia.org'],
              blockExplorerUrls: ['https://sepolia.etherscan.io']
            }]
          });
          return true;
        }
        setStatus('Please switch MetaMask to Sepolia (chainId 11155111) and reload.');
        throw err;
      }
    }

    if (UI.connectBtn) {
      UI.connectBtn.id = 'connectBtn';
      UI.connectBtn.addEventListener('click', connect);
    }

    async function connect() {
      const { ethereum } = window;
      if (!ethereum) return setStatus('MetaMask not found.');
      try {
        await ethereum.request({ method: 'eth_requestAccounts' });
        const ok = await ensureSepolia(ethereum);
        if (!ok) return;

        const provider = new ethers.providers.Web3Provider(ethereum);
        const signer = provider.getSigner();
        const contract = new ethers.Contract(config.contractAddress, abi, signer);

        setStatus('Connected on Sepolia ✔ You can proceed with owner checks & read panel (Steps 7–9).');
        window.__resume = { provider, signer, contract, config };
      } catch (e) {
        console.error(e);
        setStatus('Connection failed or denied. See console for details.');
      }
    }

    function setStatus(msg) {
      if (UI.statusEl) UI.statusEl.textContent = msg;
      else console.log('[ADMIN STATUS]', msg);
    }
  })();
  </script>

</body>
</html>
